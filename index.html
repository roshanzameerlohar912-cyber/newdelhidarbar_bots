<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEW DELHI DARBAR BILLING</title>

<style>
body{font-family:Arial;padding:15px;}
h1{margin-bottom:5px;}
select,input,button{padding:8px;margin:5px 0;}
.itemBox{border:1px solid #ccc;padding:10px;margin:5px 0;}
.billBox{border:2px solid black;padding:10px;margin-top:10px;}
.total{font-size:18px;font-weight:bold;margin-top:10px;}
.smallBtn{padding:3px 6px;font-size:12px;}
</style>
</head>
<body>

<h1>NEW DELHI DARBAR</h1>

<label>Select Table:</label>
<select id="table" onchange="loadTableBill()">
<option>Table 1</option>
<option>Table 2</option>
<option>Table 3</option>
<option>Table 4</option>
<option>Table 5</option>
</select>

<h2>Select Category</h2>
<select id="category" onchange="loadItems()">
<option value="">--Select--</option>
<option value="veg">Veg Gravy</option>
<option value="egg">Egg Gravy</option>
<option value="chicken">Chicken Gravy</option>
<option value="roti">Roti</option>
</select>

<div id="items"></div>

<h2>Bill</h2>
<div class="billBox">
<div id="bill"></div>
<div class="total" id="total">Total = â‚¹0</div>
</div>

<button onclick="holdBill()">Hold Bill</button>
<button onclick="startVoice()">ðŸŽ¤ Speak Order</button>
  h2>Voice Billing System</h2>

<button onclick="startVoice()">ðŸŽ¤ Speak Order</button>

<h3>Bill:</h3>
<div id="bill"></div>
<h3 id="total"></h3>

<script>

// MENU DATA
const menu = [
  {name:"paneer tikka masala", full:180},
  {name:"shahi paneer", full:170},
  {name:"veg kolapuri", full:140},
  {name:"dal fry", half:50, full:100},
  {name:"dal tadka", half:60, full:110}
];

let billItems = [];

function startVoice() {

  if (!('webkitSpeechRecognition' in window)) {
    alert("Use Chrome browser");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "en-IN";

  recognition.onresult = function(event) {

    const text = event.results[0][0].transcript.toLowerCase();
    processOrder(text);

  };

  recognition.start();
}

function processOrder(text) {

  let words = text.split(" ");

  let qty = 1;
  let size = "full";

  words.forEach(w => {
    if (!isNaN(w)) qty = parseInt(w);
    if (w === "half") size = "half";
  });

  menu.forEach(item => {

    if (text.includes(item.name)) {

      let price = item[size] || item.full;
      let total = price * qty;

      billItems.push({
        name: item.name,
        qty: qty,
        size: size,
        price: price,
        total: total
      });

    }

  });

  showBill();
}

function showBill() {

  let html = "";
  let grandTotal = 0;

  billItems.forEach(item => {
    html += `${item.qty} ${item.name} (${item.size}) - â‚¹${item.total}<br>`;
    grandTotal += item.total;
  });

  document.getElementById("bill").innerHTML = html;
  document.getElementById("total").innerText = "Total = â‚¹" + grandTotal;
}

</script>

</body>
<button onclick="finalSubmit()">Final Submit</button>
<button onclick="printBill()">Print</button>

<script>

let menu={
veg:[
{name:"Paneer Tikka Masala",price:180},
{name:"Shahi Paneer",price:170},
{name:"Veg Kolapuri",price:140},
{name:"Dal Fry Half",price:50},
{name:"Dal Fry Full",price:100}
],
egg:[
{name:"Egg Masala Half",price:60},
{name:"Egg Masala Full",price:100}
],
chicken:[
{name:"Chicken Masala Half",price:100},
{name:"Chicken Masala Full",price:200},
{name:"Chicken Kolapuri Half",price:100},
{name:"Chicken Kolapuri Full",price:200}
],
roti:[
{name:"Tandoori Roti",price:20},
{name:"Butter Roti",price:25},
{name:"Butter Kulcha",price:35}
]
};

let tableBills={};

function loadItems(){
let cat=document.getElementById("category").value;
let div=document.getElementById("items");
div.innerHTML="";
if(!menu[cat]) return;

menu[cat].forEach(item=>{
div.innerHTML+=`
<div class="itemBox">
<b>${item.name}</b> - â‚¹${item.price}<br>
Qty: <input type="number" value="1" min="1" id="qty_${item.name.replace(/\s/g,'')}">
<button onclick="addItem('${item.name}',${item.price})">Add</button>
</div>
`;
});
}

function addItem(name,price){
let table=document.getElementById("table").value;
let qtyInputId="qty_"+name.replace(/\s/g,'');
let qty=document.getElementById(qtyInputId).value;

if(!tableBills[table]) tableBills[table]=[];

let existing=tableBills[table].find(i=>i.name===name);
if(existing){
existing.qty+=parseInt(qty);
}else{
tableBills[table].push({name,price,qty:parseInt(qty)});
}

renderBill();
}

function renderBill(){
let table=document.getElementById("table").value;
let billDiv=document.getElementById("bill");
let totalDiv=document.getElementById("total");
billDiv.innerHTML="";
let total=0;

if(!tableBills[table]) return;

tableBills[table].forEach((item,index)=>{
let itemTotal=item.price*item.qty;
total+=itemTotal;

billDiv.innerHTML+=`
${item.name} x ${item.qty} = â‚¹${itemTotal}
<button class="smallBtn" onclick="removeItem(${index})">X</button><br>
`;
});

totalDiv.innerHTML="Total = â‚¹"+total;
}

function removeItem(index){
let table=document.getElementById("table").value;
tableBills[table].splice(index,1);
renderBill();
}

function loadTableBill(){
renderBill();
}

function holdBill(){
alert("Bill Holded for "+document.getElementById("table").value);
}

function finalSubmit(){
let table=document.getElementById("table").value;
if(!tableBills[table] || tableBills[table].length===0){
alert("No items!");
return;
}

let message="ðŸ§¾ NEW DELHI DARBAR\n"+table+"\n\n";
let total=0;

tableBills[table].forEach(item=>{
let t=item.price*item.qty;
total+=t;
message+=`${item.name} x ${item.qty} = â‚¹${t}\n`;
});

message+="------------------\nTOTAL = â‚¹"+total;

fetch('/api/bot',{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({bill:message})
});

alert("Final Bill Sent!");
tableBills[table]=[];
renderBill();
}

function printBill(){
window.print();
}

/* ---------------- VOICE SYSTEM ---------------- */

function startVoice(){

if (!('webkitSpeechRecognition' in window)) {
alert("Voice not supported. Use Chrome.");
return;
}

let recognition=new webkitSpeechRecognition();
recognition.lang="en-IN";
recognition.interimResults=false;
recognition.maxAlternatives=1;

recognition.onresult=function(event){
let speech=event.results[0][0].transcript.toLowerCase();
processVoiceOrder(speech);
};

recognition.onerror=function(){
alert("Voice error");
};

recognition.start();
}

function processVoiceOrder(text){

let table=document.getElementById("table").value;
if(!tableBills[table]) tableBills[table]=[];

let qty=1;

// number detect
let words=text.split(" ");
words.forEach(word=>{
if(!isNaN(word)){
qty=parseInt(word);
}
});

// match item
let matchedItem=null;

for(let category in menu){
menu[category].forEach(item=>{
let itemName=item.name.toLowerCase();
if(text.includes(itemName)){
matchedItem=item;
}
});
}

if(matchedItem){

let existing=tableBills[table].find(i=>i.name===matchedItem.name);

if(existing){
existing.qty+=qty;
}else{
tableBills[table].push({
name:matchedItem.name,
price:matchedItem.price,
qty:qty
});
}

renderBill();
alert("Added: "+matchedItem.name+" x "+qty);

}else{
alert("Item not found. Speak clearly.");
}

}

</script>
</body>
</html>
